import os
import json
from typing import List, Dict, Any, Optional
from datetime import datetime

import streamlit as st
import pandas as pd
from openai import OpenAI


# ============================================================
# –ù–ê–°–¢–†–û–ô–ö–ò
# ============================================================

# –§–∞–π–ª, –∫—É–¥–∞ –ö–õ–ò–ï–ù–¢–°–ö–û–ï –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
RESULTS_FILE = "deep_identity_results.json"

# –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—ã –∏ —Å—Ç–æ–ª–±—Ü—ã
POTENTIALS = [
    "–ê–º–µ—Ç–∏—Å—Ç",
    "–ì—Ä–∞–Ω–∞—Ç",
    "–¶–∏—Ç—Ä–∏–Ω",
    "–°–∞–ø—Ñ–∏—Ä",
    "–ì–µ–ª–∏–æ–¥–æ—Ä",
    "–ò–∑—É–º—Ä—É–¥",
    "–Ø–Ω—Ç–∞—Ä—å",
    "–†—É–±–∏–Ω",
    "–®—É–Ω–≥–∏—Ç",
]

COLUMNS = ["c1", "c2", "c3"]


# ============================================================
# OPENAI-–ö–õ–ò–ï–ù–¢ (–ê–ö–ö–£–†–ê–¢–ù–û!)
# ============================================================

def get_openai_client() -> Optional[OpenAI]:
    """
    –ê–∫–∫—É—Ä–∞—Ç–Ω–æ –ø–æ–ª—É—á–∞–µ–º OpenAI-–∫–ª–∏–µ–Ω—Ç:
    1) –ü—Ä–æ–±—É–µ–º st.secrets["OPENAI_API_KEY"]
    2) –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è OPENAI_API_KEY
    3) –ï—Å–ª–∏ –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–µ—Ç ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None
    """
    api_key = None

    # 1. Streamlit secrets
    try:
        api_key = st.secrets.get("OPENAI_API_KEY", None)
    except Exception:
        api_key = None

    # 2. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    if not api_key:
        api_key = os.environ.get("OPENAI_API_KEY")

    if not api_key:
        return None

    return OpenAI(api_key=api_key)


# ============================================================
# –†–ê–ë–û–¢–ê –° –§–ê–ô–õ–û–ú –†–ï–ó–£–õ–¨–¢–ê–¢–û–í
# ============================================================

def load_results() -> List[Dict[str, Any]]:
    if not os.path.exists(RESULTS_FILE):
        return []
    try:
        with open(RESULTS_FILE, "r", encoding="utf-8") as f:
            data = json.load(f)
        if isinstance(data, list):
            return data
        else:
            return []
    except Exception:
        return []


def save_results(data: List[Dict[str, Any]]) -> None:
    with open(RESULTS_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)


# ============================================================
# –ê–ì–†–ï–ì–ê–¶–ò–Ø –¢–ê–ë–õ–ò–¶–´ 3√ó3
# ============================================================

def empty_cols_dict() -> Dict[str, Dict[str, int]]:
    return {p: {c: 0 for c in COLUMNS} for p in POTENTIALS}


def aggregate_cols(record: Dict[str, Any]) -> Dict[str, Dict[str, int]]:
    """
    –°–æ–±–∏—Ä–∞–µ–º –∏—Ç–æ–≥–∏ 3√ó3 –ø–æ –≤—Å–µ–º –±–ª–æ–∫–∞–º –∑–∞–ø–∏—Å–∏ –∫–ª–∏–µ–Ω—Ç–∞.
    –û–∂–∏–¥–∞–µ–º, —á—Ç–æ –≤ record –º–æ–≥—É—Ç –±—ã—Ç—å:
      - block1_cols
      - block2_cols
      - block3_cols
      - summary_cols (–µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É–∂–µ —Å—á–∏—Ç–∞–ª–æ)
    –ú—ã –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Å—É–º–º–∏—Ä—É–µ–º –≤—Å—ë, —á—Ç–æ –µ—Å—Ç—å.
    """
    combined = empty_cols_dict()

    for key in ["block1_cols", "block2_cols", "block3_cols", "summary_cols"]:
        block_cols = record.get(key)
        if not isinstance(block_cols, dict):
            continue

        for pot in POTENTIALS:
            pot_block = block_cols.get(pot, {})
            for col in COLUMNS:
                value = pot_block.get(col, 0)
                try:
                    value = int(value)
                except Exception:
                    value = 0
                combined[pot][col] += value

    return combined


def cols_to_dataframe(cols: Dict[str, Dict[str, int]]) -> pd.DataFrame:
    rows = []
    for p in POTENTIALS:
        row = {
            "–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª": p,
            "–°—Ç–æ–ª–±–µ—Ü 1 (–∏–Ω—Ç—É–∏—Ü–∏—è/–≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ/–ø—Ä–∏—á–∏–Ω–∞)": cols[p]["c1"],
            "–°—Ç–æ–ª–±–µ—Ü 2 (–ø—Ä–æ—Ü–µ—Å—Å/—Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ/–ø—Ä–æ—è–≤–ª–µ–Ω–∏–µ)": cols[p]["c2"],
            "–°—Ç–æ–ª–±–µ—Ü 3 (—Ä–µ–∑—É–ª—å—Ç–∞—Ç/–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç/–¥–µ–π—Å—Ç–≤–∏–µ)": cols[p]["c3"],
            "–°—É–º–º–∞": cols[p]["c1"] + cols[p]["c2"] + cols[p]["c3"],
        }
        rows.append(row)
    df = pd.DataFrame(rows)
    df = df.sort_values("–°—É–º–º–∞", ascending=False)
    return df


def cols_to_markdown_table(cols: Dict[str, Dict[str, int]]) -> str:
    lines = []
    header = "| –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª | c1 (–∏–Ω—Ç—É–∏—Ü–∏—è) | c2 (–ø—Ä–æ—Ü–µ—Å—Å) | c3 (—Ä–µ–∑—É–ª—å—Ç–∞—Ç) |"
    sep = "|---|---|---|---|"
    lines.append(header)
    lines.append(sep)
    for p in POTENTIALS:
        c1 = cols[p]["c1"]
        c2 = cols[p]["c2"]
        c3 = cols[p]["c3"]
        lines.append(f"| {p} | {c1} | {c2} | {c3} |")
    return "\n".join(lines)


# ============================================================
# –ì–ï–ù–ï–†–ê–¶–ò–Ø –û–¢–ß–Å–¢–ê
# ============================================================

def build_report_prompt(record: Dict[str, Any], cols: Dict[str, Dict[str, int]]) -> str:
    client_name = record.get("client_name") or "–ö–ª–∏–µ–Ω—Ç –±–µ–∑ –∏–º–µ–Ω–∏"
    created_at = record.get("created_at") or ""

    block1_text = record.get("block1_text", "")
    block2_text = record.get("block2_text", "")
    block3_text = record.get("block3_text", "")

    table_md = cols_to_markdown_table(cols)

    prompt = f"""
–¢—ã ‚Äî –º–∞—Å—Ç–µ—Ä—Å–∫–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫ –ø–æ —Å–∏—Å—Ç–µ–º–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–≤ (–°–ü–ß) –∏ –ø–æ–º–æ–≥–∞–µ—à—å –ê—Å–µ–ª–µ –≥–æ—Ç–æ–≤–∏—Ç—å –æ—Ç—á—ë—Ç—ã –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤.
–ü–∏—à–∏ –ø—Ä–æ—Å—Ç—ã–º, –∂–∏–≤—ã–º, —á–µ–ª–æ–≤–µ—á–Ω—ã–º —Ä—É—Å—Å–∫–∏–º —è–∑—ã–∫–æ–º, –±–µ–∑ ¬´—ç–∑–æ—Ç–µ—Ä–∏—á–µ—Å–∫–æ–≥–æ –ø–∞—Ñ–æ—Å–∞¬ª, –Ω–æ —Å –≥–ª—É–±–∏–Ω–æ–π.

–≠—Ç–æ —á–µ—Ä–Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–ª–∏–µ–Ω—Ç—É.

–ò–º—è (–∫–∞–∫ –≤–≤—ë–ª —Å–∞–º —á–µ–ª–æ–≤–µ–∫): **{client_name}**
–î–∞—Ç–∞/–≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏: {created_at}

–ò—Ç–æ–≥–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–≤ 3√ó3 (—Å—É–º–º–∞ –ø–æ –≤—Å–µ–º –±–ª–æ–∫–∞–º):

{table_md}

–¢–µ–∫—Å—Ç–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞:

=== –ë–ª–æ–∫ 1. –î–µ—Ç—Å—Ç–≤–æ, —Ä–∞–Ω–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã ===
{block1_text}

=== –ë–ª–æ–∫ 2. –†–∞–±–æ—Ç–∞, –ø—Ä–æ—Ü–µ—Å—Å—ã, –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ ===
{block2_text}

=== –ë–ª–æ–∫ 3. –û–∫—Ä—É–∂–µ–Ω–∏–µ, –≥–µ—Ä–æ–∏, –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –º–∏—Ä—ã ===
{block3_text}

–ó–∞–¥–∞—á–∞: –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –î–õ–Ø –ú–ê–°–¢–ï–†–ê (–¥–ª—è –ê—Å–µ–ª–∏) –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á—ë—Ç, –∫–æ—Ç–æ—Ä—ã–π –æ–Ω–∞ –ø–æ—Ç–æ–º —Å–º–æ–∂–µ—Ç –Ω–µ–º–Ω–æ–≥–æ –ø–æ–¥–ø—Ä–∞–≤–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç—á—ë—Ç–∞:

1. –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ (3‚Äì5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π)
   - –ö–∞–∫–∞—è –æ–±—â–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –ø–æ —á–µ–ª–æ–≤–µ–∫—É
   - –ö–∞–∫–∏–µ 2‚Äì3 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞ —è–≤–Ω–æ –≤–µ–¥—É—â–∏–µ
   - –ö–∞–∫–∏–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ —Ç—Ä–∞–≤–º–∏—Ä–æ–≤–∞–Ω—ã/—Å–º–µ—â–µ–Ω—ã (–µ—Å–ª–∏ –≤–∏–¥–Ω–æ –ø–æ —Ç–µ–∫—Å—Ç—É)

2. –ö–∞—Ä—Ç–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–≤ 3√ó3 (–ø–æ —Ä—è–¥–∞–º –∏ —Å—Ç–æ–ª–±—Ü–∞–º)
   - –î–ª—è –∫–∞–∂–¥–æ–≥–æ —è—Ä–∫–æ –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ–≥–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞ –æ–ø–∏—à–∏:
     ‚Ä¢ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—ã–π —Ä—è–¥ (1, 2, 3) –∏ —Å—Ç–æ–ª–±–µ—Ü (1, 2, 3) ‚Äî –∫–∞–∫ –≥–∏–ø–æ—Ç–µ–∑–∞
     ‚Ä¢ –∫–∞–∫ —ç—Ç–æ –æ–±—ã—á–Ω–æ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –∂–∏–∑–Ω–∏ (–ø—Ä–æ—Å—Ç—ã–º–∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏)
   - –ê–∫—Ü–µ–Ω—Ç–∏—Ä—É–π –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Ç–æ–º, —á—Ç–æ —ç—Ç–æ —Ä–∞–±–æ—á–∏–µ –≥–∏–ø–æ—Ç–µ–∑—ã, –∞ –Ω–µ ¬´–æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω—ã–π –ø—Ä–∏–≥–æ–≤–æ—Ä¬ª

3. –î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä —Å–∏–ª—å–Ω—ã—Ö –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–≤
   - –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–ø-–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞:
     ‚Ä¢ –∫–∞–∫ –æ–Ω –ø—Ä–æ—è–≤–ª—è–ª—Å—è –≤ –¥–µ—Ç—Å—Ç–≤–µ (–ø–æ —Ç–µ–∫—Å—Ç—É –∫–ª–∏–µ–Ω—Ç–∞)
     ‚Ä¢ –∫–∞–∫ –æ–Ω –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è —Å–µ–π—á–∞—Å –≤ —Ä–∞–±–æ—Ç–µ/–∂–∏–∑–Ω–∏
     ‚Ä¢ –∫–∞–∫–∏–µ —Ç–∏–ø–∏—á–Ω—ã–µ –∏—Å–∫–∞–∂–µ–Ω–∏—è/—Å–º–µ—â–µ–Ω–∏—è –º–æ–≥—É—Ç –±—ã—Ç—å (–µ—Å–ª–∏ –≤–∏–¥–∏—à—å –Ω–∞–º—ë–∫–∏)

4. –†–∏—Å–∫–∏ —Å–º–µ—â–µ–Ω–∏–π –∏ —É–∑–∫–∏–µ –º–µ—Å—Ç–∞
   - –ì–¥–µ —á–µ–ª–æ–≤–µ–∫ –º–æ–∂–µ—Ç —Å–µ–±—è –æ–±–µ—Å—Ü–µ–Ω–∏–≤–∞—Ç—å, –∑–∞—Å—Ç—Ä–µ–≤–∞—Ç—å, —É—Ö–æ–¥–∏—Ç—å –≤ –∫–æ–º–ø–µ–Ω—Å–∞—Ç–æ—Ä–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
   - –ö–∞–∫ —ç—Ç–æ –º–æ–∂–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å –≤ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ—Å—Ç–∏ (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã, –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞ —Ç–µ–∫—Å—Ç–µ)

5. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è
   - 3‚Äì5 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —à–∞–≥–æ–≤ –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ 3‚Äì6 –º–µ—Å—è—Ü–µ–≤
   - –í —Ñ–æ—Ä–º–∞—Ç–µ:
     ‚Ä¢ ¬´–ß—Ç–æ –¥–µ–ª–∞—Ç—å¬ª (–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ/–ø—Ä–∞–∫—Ç–∏–∫–∞)
     ‚Ä¢ ¬´–ó–∞—á–µ–º¬ª (—á—Ç–æ —ç—Ç–æ –¥–∞—Å—Ç –µ–≥–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞–º)
   - –ë–µ–∑ –∂—ë—Å—Ç–∫–∏—Ö —É–∫–∞–∑–∞–Ω–∏–π, –≤ –º—è–≥–∫–æ–º, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ–º —Å—Ç–∏–ª–µ

–í–∞–∂–Ω–æ:
- –ù–µ –ø–µ—Ä–µ—Å–∫–∞–∑—ã–≤–∞–π –≤–µ—Å—å —Ç–µ–∫—Å—Ç –∫–ª–∏–µ–Ω—Ç–∞, –∞ –¥–µ–ª–∞–π –≤—ã–≤–æ–¥—ã.
- –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–æ–≤–∞ ¬´–ø–æ—Ö–æ–∂–µ¬ª, ¬´–≤–µ—Ä–æ—è—Ç–Ω–æ¬ª, ¬´–µ—Å—Ç—å –≥–∏–ø–æ—Ç–µ–∑–∞, —á—Ç–æ‚Ä¶¬ª.
- –ü–∏—à–∏ —Ç–∞–∫, –∫–∞–∫ –±—É–¥—Ç–æ —Ç—ã –ø–æ–º–æ–≥–∞–µ—à—å –ê—Å–µ–ª–µ –≤–∏–¥–µ—Ç—å –≥–ª—É–±–∂–µ, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ—à—å –µ–π –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö –ø—Ä–∞–≤–æ–∫.
"""
    return prompt


def generate_report(record: Dict[str, Any], cols: Dict[str, Dict[str, int]]) -> str:
    client = get_openai_client()
    if client is None:
        return (
            "‚ùå OpenAI API –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω.\n\n"
            "–î–æ–±–∞–≤—å –∫–ª—é—á –≤ Settings ‚Üí Secrets –∫–∞–∫ `OPENAI_API_KEY`, "
            "–∏–ª–∏ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ."
        )

    system_prompt = (
        "–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–∏—Å—Ç–µ–º–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–≤ (–°–ü–ß) –∏ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ê—Å–µ–ª–∏. "
        "–ü–∏—à–µ—à—å –≥–ª—É–±–æ–∫–∏–µ, –Ω–æ –ø–æ–Ω—è—Ç–Ω—ã–µ –æ—Ç—á—ë—Ç—ã, –±–µ–∑ –ø–∞—Ñ–æ—Å–∞ –∏ –∑–∞–ø—É–≥–∏–≤–∞–Ω–∏—è."
    )

    user_prompt = build_report_prompt(record, cols)

    try:
        resp = client.chat.completions.create(
            model="gpt-5.1",
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt},
            ],
            temperature=0.6,
        )
        return resp.choices[0].message.content
    except Exception as e:
        return f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–∞:\n\n`{e}`"


# ============================================================
# UI
# ============================================================

st.set_page_config(
    page_title="Deep Identity ‚Äî –º–∞—Å—Ç–µ—Ä-–≤–µ—Ä—Å–∏—è",
    layout="wide",
    page_icon="üß¨",
)

st.title("Deep Identity ¬∑ –ú–∞—Å—Ç–µ—Ä-–ø–∞–Ω–µ–ª—å –ê—Å–µ–ª–∏")
st.caption("–ó–¥–µ—Å—å —Ç–æ–ª—å–∫–æ —Ç—ã –≤–∏–¥–∏—à—å –∫–ª–∏–µ–Ω—Ç–æ–≤, –∏—Ö –æ—Ç–≤–µ—Ç—ã –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—à—å –æ—Ç—á—ë—Ç—ã.")

results = load_results()

if not results:
    st.warning(
        "–ü–æ–∫–∞ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏ –≤ "
        f"`{RESULTS_FILE}`.\n\n"
        "–£–±–µ–¥–∏—Å—å, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–º–µ–Ω–Ω–æ –≤ —ç—Ç–æ—Ç —Ñ–∞–π–ª, "
        "–∏ —á—Ç–æ –æ–±–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π/–¥–∏—Å–∫."
    )
    st.stop()

# –ù–µ–º–Ω–æ–≥–æ –æ—Ç—Å–æ—Ä—Ç–∏—Ä—É–µ–º: –Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É
results_sorted = sorted(
    results,
    key=lambda r: r.get("created_at", ""),
    reverse=True,
)

# ------------------------------------------------------------
# –°–∞–π–¥–±–∞—Ä: –≤—ã–±–æ—Ä –∫–ª–∏–µ–Ω—Ç–∞
# ------------------------------------------------------------

st.sidebar.header("–í—ã–±–æ—Ä –∫–ª–∏–µ–Ω—Ç–∞")

options = []
for idx, rec in enumerate(results_sorted):
    client_name = rec.get("client_name") or "–ë–µ–∑ –∏–º–µ–Ω–∏"
    created_at = rec.get("created_at") or ""
    label = f"{idx + 1}. {client_name} ‚Äî {created_at}"
    options.append(label)

selected_idx = st.sidebar.selectbox(
    "–ö–æ–≥–æ —Å–º–æ—Ç—Ä–∏–º?",
    options=list(range(len(options))),
    format_func=lambda i: options[i],
)

record = results_sorted[selected_idx]

client_name = record.get("client_name") or "–ö–ª–∏–µ–Ω—Ç –±–µ–∑ –∏–º–µ–Ω–∏"
created_at = record.get("created_at") or ""

st.subheader(f"–ö–ª–∏–µ–Ω—Ç: **{client_name}**")
st.write(f"–î–∞—Ç–∞/–≤—Ä–µ–º—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è: {created_at}")

# ------------------------------------------------------------
# –¢–ê–ë–´ –ü–û –†–ê–ó–ë–û–†–£
# ------------------------------------------------------------

tab_table, tab_texts, tab_raw, tab_report = st.tabs(
    ["üìä –¢–∞–±–ª–∏—Ü–∞ 3√ó3", "üìù –¢–µ–∫—Å—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞", "üßæ –°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ", "üß† –û—Ç—á—ë—Ç"]
)

cols = aggregate_cols(record)
df = cols_to_dataframe(cols)

with tab_table:
    st.markdown("### –ò—Ç–æ–≥–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–≤ 3√ó3 (—Å—É–º–º–∞—Ä–Ω–æ –ø–æ –≤—Å–µ–º –±–ª–æ–∫–∞–º)")
    st.dataframe(df, use_container_width=True)

    st.markdown(
        """
**–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–ª—è —Ç–µ–±—è (–º–∞—Å—Ç–µ—Ä):**

- **–°—Ç–æ–ª–±–µ—Ü 1 (c1)** ‚Äî –∏–Ω—Ç—É–∏—Ü–∏—è / –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ / ¬´–ø–æ—á–µ–º—É¬ª  
- **–°—Ç–æ–ª–±–µ—Ü 2 (c2)** ‚Äî –ø—Ä–æ—Ü–µ—Å—Å / —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ / ¬´–∫–∞–∫ –∏–º–µ–Ω–Ω–æ –ø—Ä–æ–∂–∏–≤–∞—é¬ª  
- **–°—Ç–æ–ª–±–µ—Ü 3 (c3)** ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç / –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç / ¬´—á–µ—Ä–µ–∑ —á—Ç–æ —Ä–µ–∞–ª–∏–∑—É—é—Å—å¬ª  
"""
    )

with tab_texts:
    st.markdown("### –ë–ª–æ–∫ 1. –î–µ—Ç—Å—Ç–≤–æ, —Ä–∞–Ω–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã")
    st.text_area(
        "–¢–µ–∫—Å—Ç –∫–ª–∏–µ–Ω—Ç–∞ (–ë–ª–æ–∫ 1)",
        value=record.get("block1_text", ""),
        height=200,
    )

    st.markdown("### –ë–ª–æ–∫ 2. –†–∞–±–æ—Ç–∞, –ø—Ä–æ—Ü–µ—Å—Å—ã, –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏")
    st.text_area(
        "–¢–µ–∫—Å—Ç –∫–ª–∏–µ–Ω—Ç–∞ (–ë–ª–æ–∫ 2)",
        value=record.get("block2_text", ""),
        height=200,
    )

    st.markdown("### –ë–ª–æ–∫ 3. –û–∫—Ä—É–∂–µ–Ω–∏–µ, –≥–µ—Ä–æ–∏, –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –º–∏—Ä—ã")
    st.text_area(
        "–¢–µ–∫—Å—Ç –∫–ª–∏–µ–Ω—Ç–∞ (–ë–ª–æ–∫ 3)",
        value=record.get("block3_text", ""),
        height=200,
    )

with tab_raw:
    st.markdown("### –°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ (–∫–∞–∫ –≤ JSON)")
    st.json(record)

with tab_report:
    st.markdown("### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞ –¥–ª—è –º–∞—Å—Ç–µ—Ä–∞")

    if "master_reports" not in st.session_state:
        st.session_state.master_reports = {}

    record_id = record.get("id", f"idx_{selected_idx}")

    existing_report = st.session_state.master_reports.get(record_id, "")

    if existing_report:
        st.info("–£ —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ —É–∂–µ –µ—Å—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á—ë—Ç (–º–æ–∂–µ—à—å –ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç –Ω–∏–∂–µ).")
    else:
        st.info("–û—Ç—á—ë—Ç–∞ –µ—â—ë –Ω–µ—Ç ‚Äî –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫.")

    if st.button("‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å / –æ–±–Ω–æ–≤–∏—Ç—å –æ—Ç—á—ë—Ç –ø–æ —ç—Ç–æ–º—É –∫–ª–∏–µ–Ω—Ç—É"):
        with st.spinner("–î—É–º–∞—é –Ω–∞–¥ –æ—Ç—á—ë—Ç–æ–º‚Ä¶"):
            report_text = generate_report(record, cols)
        st.session_state.master_reports[record_id] = report_text
        existing_report = report_text

    report_area = st.text_area(
        "–ß–µ—Ä–Ω–æ–≤–∏–∫ –æ—Ç—á—ë—Ç–∞ (—Ç—ã –º–æ–∂–µ—à—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ–¥ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º/–æ—Ç–ø—Ä–∞–≤–∫–æ–π –∫–ª–∏–µ–Ω—Ç—É)",
        value=existing_report,
        height=500,
        key=f"report_area_{record_id}",
    )

    # –û–±–Ω–æ–≤–ª—è–µ–º –≤ session_state —Ç–æ, —á—Ç–æ —Ç—ã —Ä—É–∫–∞–º–∏ –ø–æ–ø—Ä–∞–≤–∏–ª–∞
    st.session_state.master_reports[record_id] = report_area

    if report_area.strip():
        st.download_button(
            label="üíæ –°–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç –∫–∞–∫ .txt",
            data=report_area,
            file_name=f"deep_identity_report_{client_name.replace(' ', '_')}.txt",
            mime="text/plain",
        )
    else:
        st.info("–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π –æ—Ç—á—ë—Ç, —á—Ç–æ–±—ã –±—ã–ª–∞ –∫–Ω–æ–ø–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.")
